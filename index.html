<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <style>
      body { font-family: system-ui, Arial, sans-serif; padding: 12px; }
      textarea, input[type="text"] { width: 100%; box-sizing: border-box; }
      .row { margin-bottom: 10px; }
      .card { padding: 10px 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; }
      .card.ok { background: #e6ffe6; }
      .card.low { background: #fff6e6; }
      .card.missing { background: #ffe6e6; }
      .top { display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin-bottom:6px; }
      .raw { font-weight: 600; }
      .meta { text-align:right; white-space:nowrap; font-size:12px; }
      .status { font-size: 12px; opacity: .8; }
      label { font-size: 12px; display:block; margin-bottom:4px; }
      .rewrite { width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
      .legend { font-size: 12px; opacity: 0.8; margin-bottom: 8px; }
      .inline { display: inline-block; margin-right: 10px; }
      button { cursor: pointer; }
      .muted { font-size: 12px; opacity: .8; }
      #status { margin-top: 8px; font-size: 12px; opacity: .85; }
      .hr { border-top: 1px solid #eee; margin: 12px 0; }
      code { background:#f6f6f6; padding:2px 4px; border-radius:4px; }
      .grid { display:grid; grid-template-columns: 1fr; gap:0; }
      input#docId { padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
    </style>
  </head>
  <body>
    <h3>SEO Keywords</h3>
    <div class="legend">
      1) Vlož kľúčové slová (každé na nový riadok): <code>fráza|min</code> (napr. <em>vitamin c najlepsia forma|1</em>).<br>
      2) Pri každom sa zobrazí <strong>Formulácia v texte</strong> – sem copy napíše, ako to bude v článku (napr. <em>Najlepšia forma vitamínu C</em>).<br>
      <strong>Ignorovanie zadania:</strong> zapni „Začať až po prvom H1“ alebo použi marker (napr. <code>--- START ---</code>) na riadku.
    </div>

    <!-- WEB APP režim: voliteľne DOC ID -->
    <div class="row">
      <label>Google Doc ID (len pre Web App; v Docse nechaj prázdne)</label>
      <input id="docId" type="text" placeholder="1aBcD... (string z URL dokumentu)">
      <small class="muted">URL vyzerá napr. https://docs.google.com/document/d/<b>DOC_ID</b>/edit — skopíruj ten <b>DOC_ID</b>.</small>
    </div>

    <div class="row">
      <textarea id="kw" rows="7" placeholder="príklady:
vitamin c najlepsia forma|1
pestrec mariansky skusenosti|2
vitamin d3|2
"></textarea>
    </div>

    <div class="row">
      <label class="inline" title="pre presné frázy">
        <input type="checkbox" id="wholeWord" checked>
        Počítaj celé slová (pre presné frázy)
      </label>
      <label class="inline">
        <input type="checkbox" id="ignoreLinks">
        Ignorovať výskyty v odkazoch
      </label>
      <label class="inline">
        <input type="checkbox" id="accentInsensitive" checked>
        Ignorovať diakritiku (á=a, č=c…)
      </label>
    </div>

    <!-- KDE ZAČAŤ KONTROLU -->
    <div class="row">
      <label class="inline">
        <input type="checkbox" id="startAfterH1" checked>
        Začať až po prvom H1 (Heading 1)
      </label>
      <label class="inline" style="margin-top:6px; display:block;">
        Marker (nepovinné): <input type="text" id="startMarker" placeholder="napr. --- START ---" style="width:220px;">
      </label>
      <small class="muted">Ak je zadaný marker, začneme od <u>riadku za ním</u>. H1 a marker môžu fungovať aj spolu – použije sa to, čo príde skôr.</small>
    </div>

    <div class="row">
      <button onclick="scan()">Skenovať</button>
      <button onclick="highlight()">Zvýrazniť (manuálne – podľa Formulácií)</button>
      <button onclick="clearHl()">Vyčistiť zvýraznenia</button>
    </div>

    <div class="hr"></div>
    <div class="row">
      <label class="inline">
        <input type="checkbox" id="autoScan" checked>
        Auto-scan panelu (bez farbenia v texte)
      </label>
      <label class="inline">
        Interval: <input id="interval" type="number" min="1" value="2" style="width:56px;"> s
      </label>
    </div>

    <div class="hr"></div>
    <div id="cards" class="grid"></div>

    <div id="status"></div>

    <script>
      // --- stav ---
      let lastHash = '';
      let inFlight = false;
      let timer = null;
      const LS_KEY = 'seo_kw_rewrites_v1';
      window.__REWRITES = {};

      window.addEventListener('load', () => {
        loadRewritesFromLS();
        renderCards();
        attachAuto();
        scan();
      });

      function getDocId(){ return (document.getElementById('docId')?.value || '').trim(); }

      function loadRewritesFromLS(){
        try { window.__REWRITES = JSON.parse(localStorage.getItem(LS_KEY) || '{}'); }
        catch(e){ window.__REWRITES = {}; }
      }
      function saveRewritesToLS(){
        try { localStorage.setItem(LS_KEY, JSON.stringify(window.__REWRITES || {})); } catch(e){}
      }

      function setStatus(msg){ document.getElementById('status').textContent = msg || ''; }
      function showErr(e){ setStatus('Chyba: ' + (e && e.message ? e.message : e)); }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

      function parseRawLines(){
        return document.getElementById('kw').value.split('\n').map(s => s.trim()).filter(Boolean);
      }

      function parseKeywords() {
        const rawLines = parseRawLines();
        const items = [];
        rawLines.forEach(line => {
          const rewrite = (window.__REWRITES && window.__REWRITES[line]) ? window.__REWRITES[line].trim() : '';

          // manuálne NEAR cez >>
          if (!rewrite && line.includes('>>')) {
            const [lhsRaw, rightPart] = line.split('>>').map(s => s && s.trim());
            const [rhsRaw, minStr] = (rightPart || '').split('|').map(s => s && s.trim());
            const min = minStr ? Math.max(1, parseInt(minStr, 10) || 1) : 1;
            const left = (lhsRaw || '').split(/[ ,]+/).map(x => x.trim()).filter(Boolean);
            const right = (rhsRaw || '').split(/[ ,]+/).map(x => x.trim()).filter(Boolean);
            items.push({ raw: line, mode:'near', left, right, window:8, minCount: min, rewrite: '' });
            return;
          }

          // presná fráza (alebo rewrite)
          const [phrase, minStr] = line.split('|').map(s => s && s.trim());
          const min = minStr ? Math.max(1, parseInt(minStr, 10) || 1) : 1;

          items.push({
            raw: line,
            mode: 'exact',
            pattern: (phrase || ''),
            wholeWord: document.getElementById('wholeWord').checked,
            minCount: min,
            rewrite: rewrite || ''
          });
        });

        return items;
      }

      function readStartOptions(){
        return {
          afterH1: document.getElementById('startAfterH1').checked,
          markerText: (document.getElementById('startMarker').value || '').trim()
        };
      }

      function readOptions() {
        return {
          ignoreLinks: document.getElementById('ignoreLinks').checked,
          accentInsensitive: document.getElementById('accentInsensitive').checked,
          start: readStartOptions()
        };
      }

      // --- UI karty ---
      function renderCards(results) {
        const wrap = document.getElementById('cards');
        const lines = parseRawLines();

        // zosúladíme rewrites mapu s aktuálnymi riadkami
        const newMap = {};
        lines.forEach(line => { newMap[line] = (window.__REWRITES && window.__REWRITES[line]) || ''; });
        window.__REWRITES = newMap;
        saveRewritesToLS();

        // výsledky do mapy
        const resMap = new Map();
        if (Array.isArray(results)) results.forEach(r => resMap.set(r.raw, r));

        wrap.innerHTML = '';
        lines.forEach((line, idx) => {
          const r = resMap.get(line);
          const cls = r ? r.status : '';
          const count = r ? r.count : 0;
          const min = r ? r.minCount : (line.split('|')[1] ? parseInt(line.split('|')[1],10)||1 : 1);
          const statusLabel = r ? (r.status === 'ok' ? 'OK' : (r.status === 'low' ? 'Menej než min.' : 'Chýba')) : '—';

          const id = 'rw_' + idx;
          const val = window.__REWRITES[line] || '';

          const card = document.createElement('div');
          card.className = 'card ' + (cls || '');
          card.innerHTML = `
            <div class="top">
              <div class="raw">${escapeHtml(line)}</div>
              <div class="meta">
                <div><strong>${count} / ${min}</strong></div>
                <div class="status">${statusLabel}</div>
              </div>
            </div>
            <label for="${id}">Formulácia v texte</label>
            <input id="${id}" class="rewrite" type="text" value="${escapeAttr(val)}" placeholder="Sem napíš, ako to má byť v texte" />
          `;
          wrap.appendChild(card);

          setTimeout(() => {
            const input = document.getElementById(id);
            input.addEventListener('input', () => {
              window.__REWRITES[line] = input.value || '';
              try { localStorage.setItem(LS_KEY, JSON.stringify(window.__REWRITES || {})); } catch(e){}
              scan(); // okamžitý prepočet panelu
            });
          }, 0);
        });
      }

      // --- manuálne akcie ---
      function scan() {
        const items = parseKeywords();
        const options = readOptions();
        const docId = getDocId();
        setStatus('Skenujem…');
        google.script.run.withSuccessHandler((results) => {
          renderCards(results);
          setStatus('Hotovo.');
        }).withFailureHandler(showErr)
          .scanKeywords({ items, options, docId });
      }

      function highlight() {
        const base = parseKeywords();
        const items = base.map(x => {
          if (x.rewrite) return { rewrite: x.rewrite };
          if (x.mode === 'near') return { mode:'near', left:x.left, right:x.right, window:x.window };
          return { mode:'exact', pattern:x.pattern, wholeWord:x.wholeWord };
        });
        const options = readOptions();
        const docId = getDocId();
        google.script.run.withFailureHandler(showErr)
          .highlightMatches({ items, options, docId });
      }

      function clearHl() {
        const docId = getDocId();
        google.script.run.withFailureHandler(showErr)
          .clearHighlights({ docId });
      }

      // --- AUTO režim ---
      function attachAuto(){
        startAuto();
        document.getElementById('autoScan').addEventListener('change', startAuto);
        document.getElementById('interval').addEventListener('change', startAuto);

        document.getElementById('kw').addEventListener('input', () => { renderCards(); scan(); });
        document.getElementById('startAfterH1').addEventListener('change', scan);
        document.getElementById('startMarker').addEventListener('input', scan);
        const docIdEl = document.getElementById('docId');
        if (docIdEl) docIdEl.addEventListener('input', () => { lastHash=''; scan(); });
      }

      function startAuto(){
        stopAuto();
        if (!document.getElementById('autoScan').checked) return;
        const sec = Math.max(1, parseInt(document.getElementById('interval').value || '2', 10));
        timer = setInterval(checkAndScan, sec*1000);
        setStatus('Auto-scan beží ('+sec+' s).');
      }
      function stopAuto(){ if (timer) clearInterval(timer); timer = null; }

      function checkAndScan(){
        if (!document.getElementById('autoScan').checked) return;
        if (inFlight) return;
        inFlight = true;
        const options = readOptions();
        const docId = getDocId();
        google.script.run
          .withSuccessHandler(({hash}) => {
            inFlight = false;
            if (hash !== lastHash) {
              lastHash = hash;
              scan();
              setStatus('Zmeny zistené, panel aktualizovaný.');
            }
          })
          .withFailureHandler(e => { inFlight = false; showErr(e); })
          .getDocHash({ options, docId });
      }
    </script>
  </body>
</html>
